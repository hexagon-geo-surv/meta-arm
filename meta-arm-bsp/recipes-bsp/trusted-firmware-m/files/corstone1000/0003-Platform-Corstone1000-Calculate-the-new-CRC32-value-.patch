From 7596437c0d89b5a1d36930990d52c37ba66dddeb Mon Sep 17 00:00:00 2001
From: Emekcan Aras <emekcan.aras@arm.com>
Date: Mon, 15 May 2023 10:47:27 +0100
Subject: [PATCH] Platform: Corstone1000: Calculate the new CRC32 value after
 changing the metadata

Calculates the new CRC32 value for the metadata struct after chaing a value
during the capsule update. It also updates the CRC32 field in the metadata
so it doesn't fail the CRC check after a succesfull capsule update.
It also skips doing a sanity check the BL2 nv counter after the capsule
update since the tfm bl1 does not sync metadata and nv counters in OTP during
the boot anymore.

Signed-off-by: Emekcan Aras <emekcan.aras@arm.com>
Upstream-Status: Submitted [https://review.trustedfirmware.org/c/TF-M/trusted-firmware-m/+/24104/7]

---
 .../ext/target/arm/corstone1000/fw_update_agent/fwu_agent.c   | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/platform/ext/target/arm/corstone1000/fw_update_agent/fwu_agent.c b/platform/ext/target/arm/corstone1000/fw_update_agent/fwu_agent.c
index 2e6de255be..9c31aeee9d 100644
--- a/platform/ext/target/arm/corstone1000/fw_update_agent/fwu_agent.c
+++ b/platform/ext/target/arm/corstone1000/fw_update_agent/fwu_agent.c
@@ -1125,8 +1125,7 @@ static enum fwu_agent_error_t update_nv_counters(
 
     FWU_LOG_MSG("%s: enter\n\r", __func__);
 
-    for (int i = 0; i <= FWU_MAX_NV_COUNTER_INDEX; i++) {
-
+    for (int i = 1; i <= FWU_MAX_NV_COUNTER_INDEX; i++) {
         switch (i) {
             case FWU_BL2_NV_COUNTER:
                 tfm_nv_counter_i = PLAT_NV_COUNTER_BL1_0;
@@ -1147,7 +1146,6 @@ static enum fwu_agent_error_t update_nv_counters(
         if (err != TFM_PLAT_ERR_SUCCESS) {
             return FWU_AGENT_ERROR;
         }
-
         if (priv_metadata->nv_counter[i] < security_cnt) {
             return FWU_AGENT_ERROR;
         } else if (priv_metadata->nv_counter[i] > security_cnt) {
